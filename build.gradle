/*
 * File: build.gradle
 * Converted to work with Gradle as well as Maven
 * Converted from using TestNG to JUnit
 * RSK 07/31/2019
 */

plugins {
    id 'java'
    id 'maven-publish'
    id 'com.github.johnrengelman.shadow' version '5.2.0'
}

apply plugin: 'java'
apply plugin: 'com.github.johnrengelman.shadow'

repositories {
    mavenLocal()
    maven {
        url = 'https://repo.maven.apache.org/maven2'
    }

    maven {
        url = 'https://maven.repository.redhat.com/techpreview/all'
    }

    maven {
        url = 'https://repository.jboss.org/nexus/content/groups/public'
    }

    maven {
        url = 'https://repository.jboss.org/nexus/content/repositories/deprecated/'
    }

    maven {
        url = 'https://plugins.gradle.org/m2/'
    }

}

/*
 * RSK 08/01/2019
 * Updated bouncycastle dependancies from 1.49 to 1.62
 * Per:
 * Application dependency org.bouncycastle:bcprov-jdk15on-1.49 is vulnerable: 
 * CVE-2018-1000613 CVE-2016-1000341 CVE-2016-1000352 CVE-2016-1000338 CVE-2016-1000339 CVE-2016-1000344. 
 * Recommendation: use version 1.62
 */
dependencies {
    shadow localGroovy()
    shadow gradleApi()

    compile 'org.apache.logging.log4j:log4j:2.13.3'
    compile 'commons-io:commons-io:2.4'
    compile 'commons-codec:commons-codec:1.10'
    /* compile 'com.github.johnrengelman.shadow:5.2.0' */
    compile 'org.bouncycastle:bcpFjunitrov-jdk15on:1.65'
    compile 'org.bouncycastle:bcpkix-jdk15on:1.65'
    compile 'org.bouncycastle:bcpg-jdk15on:1.65'
    testCompile 'junit:junit:4.13.1'
	testCompile 'org.junit.jupiter:junit-jupiter-api:5.6.2'
}


group = 'com.rk'
version = '2.0.1'
sourceCompatibility = '1.8'
targetCompatibility = '1.8'

publishing {
    publications {
        maven(MavenPublication) {
            /*
            * groupId = group
            * artifactId = 'encryption-utils'
            * version = version
            */
            from(components.java)
        }
    }
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

/*
 * Default Jar task runs when called with:
 * gradle clean build
 * OR
 * gradle build
 */
jar {
    baseName = 'encryption-utils'  
    doFirst {
        from { configurations.compile.collect { it.isDirectory() ? it : zipTree(it) } } 
    }
    exclude 'META-INF/*.RSA', 'META-INF/*.SF','META-INF/*.DSA' 
    manifest {
        attributes(
            'Built-By'       : System.properties['user.name'],
            'Specification-Title' : baseName,
            'Build-Timestamp': new java.text.SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ").format(new Date()),
            'Build-Revision' : version,
            'Class-Path'     : configurations.compile.collect { it.getName() }.join(' '),
            'Created-By'     : "Gradle ${gradle.gradleVersion}",
            'Build-Jdk'      : "${System.properties['java.version']} (${System.properties['java.vendor']} ${System.properties['java.vm.version']})",
            'Build-OS'       : "${System.properties['os.name']} ${System.properties['os.arch']} ${System.properties['os.version']}"
        )
    }
}

/*
 * call this task to get an uber jar
 * Call like:
 * gradle clean build customFatjar
 * OR
 * gradle build customFatjar
 */
task customFatJar(type: Jar) {  
    baseName = 'encryption-utils'
    doFirst {
        from { configurations.compile.collect { it.isDirectory() ? it : zipTree(it) } } 
    }
    exclude 'META-INF/*.RSA', 'META-INF/*.SF','META-INF/*.DSA' 
    manifest {
        attributes(
            'Built-By'       : System.properties['user.name'],
            'Specification-Title' : baseName,
            'Build-Timestamp': new java.text.SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSSZ").format(new Date()),
            'Build-Revision' : version,
            'Class-Path'     : configurations.compile.collect { it.getName() }.join(' '),
            'Created-By'     : "Gradle ${gradle.gradleVersion}",
            'Build-Jdk'      : "${System.properties['java.version']} (${System.properties['java.vendor']} ${System.properties['java.vm.version']})",
            'Build-OS'       : "${System.properties['os.name']} ${System.properties['os.arch']} ${System.properties['os.version']}"
        )
    }
    from { configurations.compile.collect { it.isDirectory() ? it : zipTree(it) } }
    with jar
}